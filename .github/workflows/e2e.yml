name: e2e
on:
  workflow_call:
    inputs:
      group:
        required: true
        type: string
      config-file:
        required: true
        type: string
      base-url:
        required: true
        type: string
jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      container-count: ${{ steps.calculate-containers.outputs.count }}
    steps:
      - name: Checkout ðŸ›Ž
        uses: actions/checkout@v5

      - name: Calculate optimal container count ðŸ§®
        id: calculate-containers
        run: |
          # Extract specPattern from TypeScript config file
          # Pattern like: specPattern: "cypress/e2e/no/**/*.{js,jsx,ts,tsx}"
          SPEC_PATTERN=$(grep "specPattern:" ${{ inputs.config-file }} | sed -E 's/.*specPattern:\s*"([^"]+)".*/\1/')
          echo "Spec pattern: $SPEC_PATTERN"

          # Extract the base directory (e.g., cypress/e2e/no)
          # Remove everything after the first /** or /*
          BASE_DIR=$(echo "$SPEC_PATTERN" | sed -E 's/\/\*\*.*//')
          echo "Base directory: $BASE_DIR"

          # Count test files in that specific country directory
          if [ -d "$BASE_DIR" ]; then
            TEST_COUNT=$(find "$BASE_DIR" -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) | wc -l | tr -d ' ')
          else
            echo "Warning: Directory $BASE_DIR not found, defaulting to 1 container"
            TEST_COUNT=1
          fi

          echo "Test files found: $TEST_COUNT"

          # Ensure at least 1 container
          if [ "$TEST_COUNT" -eq 0 ]; then
            echo "No test files found, defaulting to 1 container"
            TEST_COUNT=1
          fi

          # Calculate optimal containers using scaling formula:
          # - For 1-3 tests: use equal number of containers
          # - For 4+ tests: scale with formula, capped at 12
          if [ $TEST_COUNT -le 3 ]; then
            CONTAINERS=$TEST_COUNT
          else
            # Formula: ceil(test_count / 2.5) + 1, capped at 12
            CONTAINERS=$(awk -v tc=$TEST_COUNT 'BEGIN {
              result = int((tc / 2.5) + 0.999) + 1;
              if (result > 12) result = 12;
              if (result < 1) result = 1;
              print result
            }')
          fi

          echo "Calculated containers: $CONTAINERS"
          echo "count=$CONTAINERS" >> $GITHUB_OUTPUT

      - name: Generate matrix array ðŸ“Š
        id: set-matrix
        run: |
          CONTAINERS=${{ steps.calculate-containers.outputs.count }}
          containers='['
          for i in $(seq 1 $CONTAINERS); do
            containers="${containers}${i},"
          done
          containers="${containers%,}]"
          echo "matrix=${containers}" >> $GITHUB_OUTPUT
          echo "Generated matrix: ${containers}"

  e2e:
    needs: generate-matrix
    runs-on: blacksmith-4vcpu-ubuntu-2404
    strategy:
      # when one test fails, DO NOT cancel the other
      # containers, because this will kill Cypress processes
      # leaving Cypress Cloud hanging ...
      # https://github.com/cypress-io/github-action/issues/48
      fail-fast: false
      matrix:
        containers: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout ðŸ›Ž
        uses: actions/checkout@v5
      - name: Run Cypress ðŸŒ²
        uses: cypress-io/github-action@v6
        with:
          config-file: ${{ inputs.config-file }}
          record: true
          parallel: true
          group: ${{ inputs.group }}
          ci-build-id: ${{ github.run_id }}-${{ inputs.group }}
        env:
          CYPRESS_BASE_URL: ${{ inputs.base-url }}
          CYPRESS_AUTH_DOMAIN: ${{ secrets.CYPRESS_AUTH_DOMAIN }}
          CYPRESS_AUTH_CLIENT_ID: ${{ secrets.CYPRESS_AUTH_CLIENT_ID }}
          CYPRESS_AUTH_CLIENT_SECRET: ${{ secrets.CYPRESS_AUTH_CLIENT_SECRET }}
          CYPRESS_AUTH_AUDIENCE: ${{ secrets.CYPRESS_AUTH_AUDIENCE }}
          CYPRESS_AUTH_USERNAME: ${{ secrets.CYPRESS_AUTH_USERNAME }}
          CYPRESS_AUTH_PASSWORD: ${{ secrets.CYPRESS_AUTH_PASSWORD }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
