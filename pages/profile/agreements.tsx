import Head from "next/head";
import { Layout } from "../../components/profile/layout";
import { LayoutPage } from "../../types";
import "react-toastify/dist/ReactToastify.css";
import { AgreementList } from "../../components/lists/agreementList/agreementList";
import {
  AvtaleGiroAgreement,
  Distribution,
  Organization,
  VippsAgreement,
} from "../../models";
import { Spinner } from "../../components/elements/spinner";
import { useAuth0, User } from "@auth0/auth0-react";
import {
  useAgreementsDistributions,
  useAvtalegiroAgreements,
  useOrganizations,
  useVippsAgreements,
} from "../../_queries";
import { useContext } from "react";
import { ActivityContext } from "../../components/profile/activityProvider";
import { Children, Lightbox } from "../../components/elements/lightbox";

const Agreements: LayoutPage = () => {
  const { getAccessTokenSilently, user } = useAuth0();
  const { setActivity } = useContext(ActivityContext);

  const {
    loading: avtaleGiroLoading,
    data: avtaleGiro,
    isValidating: avtaleGiroRefreshing,
    error: avtaleGiroError,
  } = useAvtalegiroAgreements(user as User, getAccessTokenSilently);

  const {
    loading: vippsLoading,
    data: vipps,
    isValidating: vippsRefreshing,
    error: vippsError,
  } = useVippsAgreements(user as User, getAccessTokenSilently);

  const {
    loading: organizationsLoading,
    data: organizations,
    isValidating: organizationsRefreshing,
    error: organizationsError,
  } = useOrganizations(user as User, getAccessTokenSilently);

  const kids = new Set<string>();
  if (vipps && avtaleGiro)
    [
      ...vipps?.map((a: VippsAgreement) => a.KID),
      ...avtaleGiro?.map((a: AvtaleGiroAgreement) => a.KID),
    ].map((kid) => kids.add(kid));

  const {
    loading: distributionsLoading,
    data: distributions,
    isValidating: distributionsRefreshing,
    error: distributionsError,
  } = useAgreementsDistributions(
    user as User,
    getAccessTokenSilently,
    !vippsLoading && !avtaleGiroLoading,
    Array.from(kids)
  );

  const loading =
    vippsLoading ||
    avtaleGiroLoading ||
    distributionsLoading ||
    organizationsLoading;

  const refreshing =
    avtaleGiroRefreshing ||
    vippsRefreshing ||
    organizationsRefreshing ||
    distributionsRefreshing;

  if (loading || !organizations || !distributions || !vipps || !avtaleGiro)
    return (
      <>
        <h1>Faste avtaler</h1>
        <Spinner />
      </>
    );

  if (refreshing) setActivity(true);
  else setActivity(false);

  const distributionsMap = getDistributionMap(distributions, organizations);

  const lightboxChildren: Children = {
    button: "Avslutt",
    heading: "Avslutt avtale",
    paragraph: [
      `Hvis du avslutter din betalingsavtale hos oss vil vi slutte å trekke deg.`,
      `Dersom du har en avtalegiro avtale og den har trekkdato nærmere enn 6 dager tilbake i tid 
    har vi allerede sendt melding til banksystemene om å trekke deg. Dette skyldes tregheter i 
    registrering av trekk hos bankene. Om du ønsker refusjon på denne donasjonen kan du ta kontakt på donasjon@gieffektivt.no`,
    ],
  };

  return (
    <>
      <Head>
        <title>Konduit. - Avtaler</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        <h1>Faste avtaler</h1>
        <Lightbox>{lightboxChildren}</Lightbox>
        <AgreementList
          title={"Aktive"}
          vipps={vipps.filter(
            (agreement: VippsAgreement) => agreement.status === "ACTIVE"
          )}
          avtalegiro={avtaleGiro.filter(
            (agreement: AvtaleGiroAgreement) => agreement.active
          )}
          distributions={distributionsMap}
          supplemental={"Dette er dine aktive betalingsavtaler du har med oss"}
        />
        <AgreementList
          title={"Inaktive"}
          vipps={vipps.filter(
            (agreement: VippsAgreement) => agreement.status !== "ACTIVE"
          )}
          avtalegiro={avtaleGiro.filter(
            (agreement: AvtaleGiroAgreement) => !agreement.active
          )}
          distributions={distributionsMap}
          supplemental={
            "Dette er tidligere faste betalingsavtaler du har hatt med oss, som vi ikke lenger trekker deg for"
          }
        />
      </div>
    </>
  );
};

Agreements.layout = Layout;
export default Agreements;

const getDistributionMap = (
  distributions: Distribution[],
  organizations: Organization[]
) => {
  const map = new Map<string, Distribution>();

  for (let i = 0; i < distributions.length; i++) {
    let dist = distributions[i];

    let newDist = {
      kid: "",
      organizations: organizations.map((org) => ({
        id: org.id,
        name: org.name,
        share: "0",
      })),
    };

    for (let j = 0; j < dist.organizations.length; j++) {
      let org = dist.organizations[j];
      let index = newDist.organizations.map((o) => o.id).indexOf(org.id);
      newDist.organizations[index].share = org.share;
    }

    map.set(dist.kid, { ...newDist });
  }

  return map;
};
